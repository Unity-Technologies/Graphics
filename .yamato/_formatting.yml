# Documentation: https://internaldocs.hq.unity3d.com/unity-meta/

formatting:
    name: Formatting
    agent:
        type: Unity::VM
        image: package-ci/ubuntu:stable
        flavor: b1.small
    commands:
      -  "echo -e \"[extensions]\nlargefiles=\n\" > ~/.hgrc"
      -  hg clone -u stable http://hg-mirror-slo.hq.unity3d.com/unity-extra/unity-meta ~/unity-meta
      -  perl ~/unity-meta/Tools/Format/format.pl --reporoot $(pwd) --dry-run .
    timeout: 1
    triggers:
        expression: pull_request.target eq "master"

formatting_preview:
    name: Formatting (Preview diff)
    agent:
        type: Unity::VM
        image: package-ci/ubuntu:stable
        flavor: b1.small
    commands:
      -  "echo -e \"[extensions]\nlargefiles=\n\" > ~/.hgrc"
      -  hg clone -u stable http://hg-mirror-slo.hq.unity3d.com/unity-extra/unity-meta ~/unity-meta
      -  perl ~/unity-meta/Tools/Format/format.pl --reporoot $(pwd) --preview .
      -  cat ./format.patch
    timeout: 1
    artifacts:
      diff:
        paths:
          - format.patch

formatting_apply:
    name: Formatting (Apply requested changes)
    agent:
        type: Unity::VM
        image: package-ci/ubuntu:stable
        flavor: b1.small
    commands:
      -  "echo -e \"[extensions]\nlargefiles=\n\" > ~/.hgrc"
      -  hg clone -u stable http://hg-mirror-slo.hq.unity3d.com/unity-extra/unity-meta ~/unity-meta
      -  perl ~/unity-meta/Tools/Format/format.pl --reporoot $(pwd) --nobackups .
      -  git config --global user.name "noreply@unity3d.com"
      -  git config --global user.email "noreply@unity3d.com"
      -  git checkout $GIT_BRANCH
      -  git add .
      -  git commit -m "Apply formatting changes"
      -  git push --set-upstream origin $GIT_BRANCH
    timeout: 1
