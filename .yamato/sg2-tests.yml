ShaderGraph2_Win_pr_trigger:
  name: ShaderGraph2 - PR Tests Trigger
  triggers:
    expression: pull_request.source match "(?:^|.+\/)sg2\/.+" AND NOT pull_request.draft # this trigger the job on pull request exclusively on specific branches
    cancel_old_ci: true
  dependencies:
    -  path: .yamato/sg2-tests.yml#ShaderGraph2_Win
       rerun: on_new_revision
    -  path: .yamato/sg2-tests.yml#ShaderGraph2_Mac
       rerun: on_new_revision
ShaderGraph2_Win:
  name: ShaderGraph2 Tests - Win
  agent:
    type: Unity::VM
    image: sdet/gamecode_win10:stable
    flavor: b1.large
  variables:
    UTR_VERSION: "current"
    TEST_FILTER: .*
    EDITOR_BRANCH: "gtf/staging"
  commands:
    -  command: NetSh Advfirewall set allprofiles state off
    -  command: curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
       retries: 2
    -  command: choco install unity-downloader-cli -y -s https://artifactory.prd.it.unity3d.com/artifactory/api/nuget/unity-choco-local
       retries: 2
    -  command: unity-downloader-cli -u gtf/staging -c editor --fast
       retries: 2
    -  command: utr --editor-location=.Editor --platform=editmode --scripting-backend=Mono2x --suite=editor --testproject=./ShaderGraphPlayground
  artifacts:
    logs:
      paths:
        -  "**/test-results/**"
        -  "ShaderGraphPlayground/Logs/*.log"
ShaderGraph2_Mac:
  name: ShaderGraph2 Tests - Mac
  agent:
    type: Unity::VM::osx
    image: slough-ops/macos-11-xcode:v0.0.1-973582
    flavor: m1.mac
    variables:
        UPM_REGISTRY: https://artifactory-slo.bf.unity3d.com/artifactory/api/npm/upm-candidates
        CUSTOM_REVISION: '{{trunk.changeset.id}}'
        CACHE_ARGS: '{{cache.flags}}'
        UTR_VERSION: "current"
        TEST_FILTER: .*
    commands:
      -  command: pip3 install unity-downloader-cli --index-url https://artifactory.prd.it.unity3d.com/artifactory/api/pypi/pypi/simple --upgrade
      -  command: $(python3 -m site --user-base)/bin/unity-downloader-cli -u gtf/staging -c editor --fast --wait
      -  command: curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
         retries: 2
      -  command: chmod +x utr
      -  command: utr --editor-location=.Editor --platform=editmode --scripting-backend=Mono2x --suite=editor --testproject=./ShaderGraphPlayground
         retries: 2
    artifacts:
        logs:
            paths:
              -  "**/test-results/**"
              -  "ShaderGraphPlayground/Logs/*.log"
#   artifacts:
#     CodeCoverageReport:
#       paths:
#         - CodeCoverageReport/**
#     CodeCoverageResults:
#       paths:
#         - CodeCoverageResults/**
#     logs:
#       paths:
#         - build/ReportedArtifacts/**
# variables:
#   UTR_VERSION: "current"
#   TEST_FILTER: .*
#   EDITOR_BRANCH: "gtf/staging"
# commands:
#   - command: curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr --output utr
#     retries: 2
#   -  chmod +x utr
      #-  command: perl utr.pl --suite=editor --artifacts_path=$PWD/build/ReportedArtifacts/ --testprojects={{ project.testproject }} --reruncount=2 --enable-code-coverage --coverage-pkg-version={{coverage_meta.COVERAGE_PKG_VER}} --coverage-results-path=$PWD/CodeCoverageResults --coverage-options="generateAdditionalMetrics;assemblyFilters:+Unity.GraphTools.Foundation*;pathStrippingPatterns:$PWD/{{project.path}}/Packages/;verbosity:warning;generateHtmlReport;"
